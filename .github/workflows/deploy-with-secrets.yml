name: Deploy to cPanel

on:
  push:
    branches: [ restore_branch ]
  workflow_dispatch:
    # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Create Express .env file
      run: |
        echo "# MongoDB Atlas Connection" > .env
        echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env
        echo "MONGODB_DB=FreshShareDB" >> .env
        echo "PORT=3001" >> .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
        echo "FASTIFY_BACKEND_URL=http://localhost:8080" >> .env
        echo "NODE_ENV=production" >> .env

    - name: Create Fastify .env file
      run: |
        mkdir -p fastify-backend
        echo "PORT=8080" > fastify-backend/.env
        echo "DATABASE_URL=postgres://myfrovov_freshshare_user:BjgjX2Vev2vmLwh@localhost:5432/myfrovov_freshshare" >> fastify-backend/.env
        echo "NODE_ENV=production" >> fastify-backend/.env

    - name: Verify scripts exist
      run: |
        if [ ! -f "start-express.sh" ]; then
          echo "ERROR: start-express.sh is missing!"
          exit 1
        fi
        if [ ! -f "fastify-backend/start-fastify.sh" ]; then
          echo "ERROR: fastify-backend/start-fastify.sh is missing!"
          exit 1
        fi
        echo "Scripts verified successfully"

    - name: Debug list startup scripts
      run: |
        ls -la
        ls -la fastify-backend || true

    - name: Install dependencies locally
      run: |
        # Clean Express dependencies
        rm -rf node_modules package-lock.json
        if ! npm install --production; then
          echo "npm install failed for Express. Exiting."
          exit 1
        fi
        
        # Clean Fastify dependencies
        cd fastify-backend
        rm -rf node_modules package-lock.json
        if ! npm install --production; then
          echo "npm install failed for Fastify. Exiting."
          exit 1
        fi
        cd ..

    - name: Make startup scripts executable
      run: |
        chmod +x start-express.sh
        chmod +x fastify-backend/start-fastify.sh
        
    - name: Set up SSH key
      run: |
        # Create SSH directory with proper permissions
        mkdir -p ~/.ssh || true
        chmod 700 ~/.ssh
        
        # Write the private key with proper formatting
        echo "${{ secrets.actions_deploy_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add server to known hosts
        ssh-keyscan -p ${{ secrets.SFTP_PORT }} -H ${{ secrets.FTP_SERVER }} >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Debug: Check key format
        echo "Key starts with:"
        head -1 ~/.ssh/id_rsa
        echo "Key ends with:"
        tail -1 ~/.ssh/id_rsa
        
        # Test SSH connection
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} echo "SSH connection successful"

    - name: Ensure remote directories exist
      run: |
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} 'mkdir -p ~/freshshare1.3 ~/freshshare1.3/fastify-backend'

    - name: SFTP Deploy to cPanel
      uses: wlixcc/SFTP-Deploy-Action@master
      with:
        server: ${{ secrets.FTP_SERVER }}
        port: ${{ secrets.SFTP_PORT }}
        username: myfrovov
        ssh_private_key: ${{ secrets.actions_deploy_key }}
        ssh_passphrase: ""
        sftp_only: true
        local_path: ./*
        remote_path: freshshare1.3/
        rsyncArgs: --exclude=.git --exclude=.github --exclude=deployment-packages --exclude=deployment --exclude=data/**

    - name: Post-deployment restart services
      run: |
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} '
          # Detect Node.js paths on cPanel
          echo "Detecting Node.js installation..."
          
          # Check for Node.js App in cPanel - prioritize Node.js 18
          if [ -d "$HOME/nodevenv" ]; then
            echo "Found cPanel Node.js App environment"
            echo "Available Node.js apps:"
            ls -la $HOME/nodevenv/ || echo "Cannot list nodevenv directory"
            
            # Look for any app with Node.js 18
            NODE_VERSION_DIR=$(find $HOME/nodevenv -path "*/18/bin" -type d | head -1)
            if [ -z "$NODE_VERSION_DIR" ]; then
              # Look for any Node.js version (including v14, v16, etc.)
              NODE_VERSION_DIR=$(find $HOME/nodevenv -name "bin" -type d | head -1)
              if [ -n "$NODE_VERSION_DIR" ]; then
                DETECTED_VERSION=$($NODE_VERSION_DIR/node --version 2>/dev/null || echo "unknown")
                echo "WARNING: Node.js 18 not found, using: $NODE_VERSION_DIR (version: $DETECTED_VERSION)"
                echo "Please update your cPanel Node.js App to version 18 for full compatibility"
              fi
            fi
            
            if [ -n "$NODE_VERSION_DIR" ]; then
              NODE_BIN="$NODE_VERSION_DIR/node"
              NPM_BIN="$NODE_VERSION_DIR/npm"
              export PATH="$NODE_VERSION_DIR:$PATH"
              echo "Using cPanel Node.js App: $NODE_BIN"
              # Check Node.js version
              $NODE_BIN --version || echo "Failed to get Node.js version"
            else
              echo "ERROR: No Node.js application found in cPanel"
              echo "Please create a Node.js application in cPanel first"
            fi
          else
            echo "ERROR: No cPanel Node.js environment found"
            echo "Please create a Node.js application in cPanel"
          fi
          
          # If not found, check common paths
          if [ -z "$NODE_BIN" ]; then
            NODE_PATHS=(
              "/opt/cpanel/ea-nodejs18/bin"
              "/opt/cpanel/ea-nodejs20/bin"
              "/usr/local/bin"
              "/usr/bin"
            )
            
            for path in "${NODE_PATHS[@]}"; do
              if [ -f "$path/node" ] && [ -f "$path/npm" ]; then
                NODE_BIN="$path/node"
                NPM_BIN="$path/npm"
                export PATH="$path:$PATH"
                echo "Found Node.js at: $NODE_BIN"
                break
              fi
            done
          fi
          
          # Final fallback - try to find npm separately
          if [ -z "$NPM_BIN" ] || [ ! -f "$NPM_BIN" ]; then
            NPM_BIN=$(find /usr -name "npm" -type f 2>/dev/null | head -1)
            if [ -z "$NPM_BIN" ]; then
              NPM_BIN=$(find $HOME -name "npm" -type f 2>/dev/null | head -1)
            fi
            echo "Found npm at: $NPM_BIN"
          fi
          
          # Use system PATH as last resort
          if [ -z "$NODE_BIN" ]; then
            NODE_BIN=$(which node 2>/dev/null || echo "node")
            echo "Using system node: $NODE_BIN"
          fi
          
          if [ -z "$NPM_BIN" ]; then
            NPM_BIN=$(which npm 2>/dev/null || echo "npm")
            echo "Using system npm: $NPM_BIN"
          fi
          
          # Make scripts executable
          chmod +x ~/freshshare1.3/start-express.sh
          chmod +x ~/freshshare1.3/fastify-backend/start-fastify.sh
          
          # Install dependencies on server
          cd ~/freshshare1.3/fastify-backend
          echo "Installing Fastify dependencies on server..."
          if [ -f "$NPM_BIN" ] && [ -x "$NPM_BIN" ]; then
            $NPM_BIN install --production || echo "npm install failed for Fastify"
          else
            echo "npm not available, using pre-deployed dependencies"
          fi
          
          # Create .env file for Fastify if it doesn'\''t exist
          if [ ! -f ".env" ]; then
            echo "Creating .env file for Fastify backend..."
            echo "NODE_ENV=production" > .env
            echo "PORT=8080" >> .env
            echo "DATABASE_URL=postgresql://localhost:5432/freshshare" >> .env
            echo ".env file created for Fastify"
          else
            echo "Existing .env file found for Fastify"
            cat .env
          fi
          
          # Start Fastify backend with detailed error checking
          echo "Starting Fastify backend..."
          pkill -f "node.*server.ts" || true
          
          # Create server.js content as separate file using proper YAML multi-line string
          echo "Creating production-ready CommonJS version..."
          cat > server.js << 'EOF'
          require('dotenv/config');
          const fastify = require('fastify');
          const { Pool } = require('pg');
          
          // Config
          const PORT = Number(process.env.PORT || 8080);
          const DATABASE_URL = process.env.DATABASE_URL || 'postgres://localhost:5432/freshshare';
          console.log('Starting server on port:', PORT);
          console.log('Using database URL (redacted):', DATABASE_URL.replace(/:\/\/[^:]+:[^@]+@/, '://***:***@'));
          
          // Create app
          const app = fastify({ logger: true, trustProxy: true });
          
          // Basic health check endpoint
          app.get('/health', async () => ({ ok: true }));
          
          // Minimal parse-label endpoint
          app.post('/parse-label', async (req, reply) => {
            const body = req.body || {};
            return { gtinCase: body.text?.slice(0, 14) || null };
          });
          
          // Minimal case-pack endpoint
          app.get('/case-pack', async (req, reply) => {
            return { items: [] };
          });
          
          // Start server
          app.listen({ port: PORT, host: '0.0.0.0' })
            .then(() => {
              console.log(`FreshShare backend listening on port ${PORT}`);
              // Create a status file to indicate successful startup
              require('fs').writeFileSync('.server_running', new Date().toISOString());
            })
            .catch((err) => { 
              console.error('Server startup error:', err); 
              process.exit(1); 
            });
          EOF
          
          # Test the CommonJS server
          echo "Testing direct Node.js startup with production server.js..."
          NODE_ENV=production $NODE_BIN server.js & 
          SERVER_PID=$!
          echo "Started with PID: $SERVER_PID"
          
          # Give it a few seconds to start
          sleep 5
          
          # Check if running
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "Server started successfully with PID: $SERVER_PID"
            # Kill the test server
            kill $SERVER_PID
          else
            echo "ERROR: Server failed to start"
            exit 1
          fi
          
          # Create a startup script for the server
          echo "Creating start-backend.sh script..."
          cat > start-backend.sh << 'EOFSHELL'
#!/bin/bash
export NODE_ENV=production

# Get the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$DIR"

# Load environment variables
if [ -f ".env" ]; then
  export $(grep -v '^#' .env | xargs)
fi

# Start the server
node server.js
EOFSHELL
          
          # Make the script executable
          chmod +x start-backend.sh
          
          echo "Starting server in background using the script..."
          nohup ./start-backend.sh > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "Backend started with PID: $BACKEND_PID"
          
          # Wait to confirm successful startup
          sleep 5
          
          # Check if running and if our status file was created
          if kill -0 $BACKEND_PID 2>/dev/null && [ -f ".server_running" ]; then
            echo "Server confirmed running successfully"
            cat .server_running
            
            # Test database connection
            echo "Testing database connection..."
            $NODE_BIN -e "const { Pool } = require('pg'); const pool = new Pool({connectionString: process.env.DATABASE_URL}); pool.query('SELECT 1').then(() => console.log('DB connection successful')).catch(e => console.error('DB connection failed:', e)).finally(() => process.exit(0));"
          else
            echo "ERROR: Server may have failed to start properly"
            cat backend.log || echo "No log file found"
            exit 1
          fi
          sleep 5
          
          # Install Express dependencies
          cd ~/freshshare1.3
          echo "Installing Express dependencies on server..."
          if [ -f "$NPM_BIN" ] && [ -x "$NPM_BIN" ]; then
            $NPM_BIN install --production || echo "npm install failed for Express"
          else
            echo "npm not available, using pre-deployed dependencies"
          fi
          
          # Start Express server with detailed error checking
          echo "Starting Express server..."
          pkill -f "node server.js" || true
          
          # Test Express startup directly first
          echo "Testing Express startup..."
          if ! timeout 10 $NODE_BIN server.js; then
            echo "ERROR: Express failed to start. Exit code: $?"
            echo "Checking Express configuration..."
            ls -la
            echo "Package.json contents:"
            cat package.json | head -20 || echo "No package.json found"
            exit 1
          fi
          
          echo "Express test successful, starting in background..."
          nohup ./start-express.sh > express.log 2>&1 &
          EXPRESS_PID=$!
          echo "Express started with PID: $EXPRESS_PID"
          
          # Verify services are running
          sleep 3
          ps aux | grep node || echo "No node processes found"
        '
