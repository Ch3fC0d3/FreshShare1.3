name: Deploy to cPanel

on:
  push:
    branches: [ restore_branch ]
  workflow_dispatch:
    # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Create Express .env file
      run: |
        echo "# MongoDB Atlas Connection" > .env
        echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env
        echo "MONGODB_DB=FreshShareDB" >> .env
        echo "PORT=3001" >> .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
        echo "FASTIFY_BACKEND_URL=http://localhost:8080" >> .env
        echo "NODE_ENV=production" >> .env

    - name: Create Fastify .env file
      env:
        DATABASE_SSL: ${{ secrets.DATABASE_SSL }}
      run: |
        mkdir -p fastify-backend
        echo "PORT=8080" > fastify-backend/.env
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> fastify-backend/.env
        echo "DATABASE_SSL=${DATABASE_SSL:-false}" >> fastify-backend/.env
        echo "NODE_ENV=production" >> fastify-backend/.env

    - name: Prepare Fastify Production Files
      run: |
        # Create production-ready server.js
        cat > fastify-backend/server.js << 'EOF'
        require('dotenv/config');
        const fastify = require('fastify');
        const { Pool } = require('pg');
        
        // Config
        const PORT = Number(process.env.PORT || 8080);
        const DATABASE_URL = process.env.DATABASE_URL || 'postgres://localhost:5432/freshshare';
        console.log('Starting server on port:', PORT);
        console.log('Using database URL (redacted):', DATABASE_URL.replace(/:\\/\\/[^:]+:[^@]+@/, '://***:***@'));
        
        // Create app
        const app = fastify({ 
          logger: true,
          trustProxy: true
        });
        
        // Basic health check endpoint
        app.get('/health', async () => ({ ok: true }));
        
        // Minimal parse-label endpoint
        app.post('/parse-label', async (req, reply) => {
          const body = req.body || {};
          return { gtinCase: body.text?.slice(0, 14) || null };
        });
        
        // Minimal case-pack endpoint
        app.get('/case-pack', async (req, reply) => {
          return { items: [] };
        });
        
        // Start server
        app.listen({ port: PORT, host: '0.0.0.0' })
          .then(() => {
            console.log(`FreshShare backend listening on port ${PORT}`);
            // Create a status file to indicate successful startup
            require('fs').writeFileSync('.server_running', new Date().toISOString());
          })
          .catch((err) => { 
            console.error('Server startup error:', err); 
            process.exit(1); 
          });
        EOF
        
        # Create startup script
        cat > fastify-backend/start-backend-prod.sh << 'EOF'
        #!/bin/bash
        # Production startup script with proper process management for Fastify backend
        
        # Print commands as they execute
        set -x
        
        # Set environment
        export NODE_ENV=production
        
        # Get the directory of this script
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"
        
        # Kill any existing processes
        pkill -f "node server.js" || echo "No existing processes found"
        
        # Load environment variables from .env file
        if [ -f ".env" ]; then
          # Export all non-comment lines from .env
          set -a
          source .env
          set +a
          echo "Environment loaded from .env file"
        fi
        
        # Verify required variables
        echo "Using PORT: ${PORT:-8080}"
        echo "Using NODE_ENV: ${NODE_ENV:-production}"
        
        # Start the server in background with proper detachment
        echo "Starting Fastify backend server..."
        node server.js > fastify.log 2>&1 &
        
        # Save PID
        PID=$!
        echo $PID > .fastify.pid
        echo "Server started with PID: $PID"
        
        # Wait briefly and verify process is running
        sleep 5
        if kill -0 $PID 2>/dev/null; then
          echo "Server is running with PID: $PID"
          
          # Check for server_running status file
          if [ -f ".server_running" ]; then
            echo "Server startup successful:"
            cat .server_running
            exit 0
          else
            echo "WARNING: Process is running but .server_running file not created yet."
            echo "Waiting additional time..."
            sleep 5
            if [ -f ".server_running" ]; then
              echo "Server startup successful:"
              cat .server_running
              exit 0
            else
              echo "ERROR: Server running but didn't create status file. Check logs:"
              cat fastify.log
              exit 1
            fi
          fi
        else
          echo "ERROR: Server failed to start properly. Check logs:"
          cat fastify.log
          exit 1
        fi
        EOF
        
        # Make scripts executable
        chmod +x fastify-backend/start-backend-prod.sh

    - name: Verify scripts exist
      run: |
        if [ ! -f "start-express.sh" ]; then
          echo "ERROR: start-express.sh is missing!"
          exit 1
        fi
        if [ ! -f "fastify-backend/start-backend-prod.sh" ]; then
          echo "ERROR: fastify-backend/start-backend-prod.sh is missing!"
          exit 1
        fi
        echo "Scripts verified successfully"

    - name: Debug list startup scripts
      run: |
        ls -la
        ls -la fastify-backend || true

    - name: Install dependencies locally
      run: |
        # Clean Express dependencies
        rm -rf node_modules package-lock.json
        if ! npm install --production; then
          echo "npm install failed for Express. Exiting."
          exit 1
        fi
        
        # Clean Fastify dependencies
        cd fastify-backend
        rm -rf node_modules package-lock.json
        if ! npm install --production fastify pg dotenv; then
          echo "npm install failed for Fastify. Exiting."
          exit 1
        fi
        cd ..

    - name: Make startup scripts executable
      run: |
        chmod +x start-express.sh
        chmod +x fastify-backend/start-backend-prod.sh
        
    - name: Set up SSH key
      run: |
        # Create SSH directory with proper permissions
        mkdir -p ~/.ssh || true
        chmod 700 ~/.ssh
        
        # Write the private key with proper formatting
        echo "${{ secrets.actions_deploy_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add server to known hosts
        ssh-keyscan -p ${{ secrets.SFTP_PORT }} -H ${{ secrets.FTP_SERVER }} >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Debug: Check key format
        echo "Key starts with:"
        head -1 ~/.ssh/id_rsa
        echo "Key ends with:"
        tail -1 ~/.ssh/id_rsa
        
        # Test SSH connection
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} echo "SSH connection successful"

    - name: Ensure remote directories exist
      run: |
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} 'mkdir -p ~/freshshare1.3 ~/freshshare1.3/fastify-backend'

    - name: SFTP Deploy to cPanel
      uses: wlixcc/SFTP-Deploy-Action@master
      with:
        server: ${{ secrets.FTP_SERVER }}
        port: ${{ secrets.SFTP_PORT }}
        username: myfrovov
        ssh_private_key: ${{ secrets.actions_deploy_key }}
        ssh_passphrase: ""
        sftp_only: true
        local_path: ./*
        remote_path: freshshare1.3/
        rsyncArgs: --exclude=.git --exclude=.github --exclude=deployment-packages --exclude=deployment --exclude=data/**

    - name: Post-deployment setup - Node.js detection
      run: |
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} '
          # Detect Node.js paths on cPanel
          echo "Detecting Node.js installation..."
          
          # Check for Node.js App in cPanel - prioritize Node.js 18
          if [ -d "$HOME/nodevenv" ]; then
            echo "Found cPanel Node.js App environment"
            echo "Available Node.js apps:"
            ls -la $HOME/nodevenv/ || echo "Cannot list nodevenv directory"
            
            # Look for any app with Node.js 18
            NODE_VERSION_DIR=$(find $HOME/nodevenv -path "*/18/bin" -type d | head -1)
            if [ -z "$NODE_VERSION_DIR" ]; then
              # Look for any Node.js version (including v14, v16, etc.)
              NODE_VERSION_DIR=$(find $HOME/nodevenv -name "bin" -type d | head -1)
              if [ -n "$NODE_VERSION_DIR" ]; then
                DETECTED_VERSION=$($NODE_VERSION_DIR/node --version 2>/dev/null || echo "unknown")
                echo "WARNING: Node.js 18 not found, using: $NODE_VERSION_DIR (version: $DETECTED_VERSION)"
                echo "Please update your cPanel Node.js App to version 18 for full compatibility"
              fi
            fi
            
            if [ -n "$NODE_VERSION_DIR" ]; then
              NODE_BIN="$NODE_VERSION_DIR/node"
              NPM_BIN="$NODE_VERSION_DIR/npm"
              export PATH="$NODE_VERSION_DIR:$PATH"
              echo "Using cPanel Node.js App: $NODE_BIN"
              # Check Node.js version
              $NODE_BIN --version || echo "Failed to get Node.js version"
            else
              echo "ERROR: No Node.js application found in cPanel"
              echo "Please create a Node.js application in cPanel first"
            fi
          else
            echo "ERROR: No cPanel Node.js environment found"
            echo "Please create a Node.js application in cPanel"
          fi
          
          # If not found, check common paths
          if [ -z "$NODE_BIN" ]; then
            NODE_PATHS=(
              "/opt/cpanel/ea-nodejs18/bin"
              "/opt/cpanel/ea-nodejs20/bin"
              "/usr/local/bin"
              "/usr/bin"
            )
            
            for path in "${NODE_PATHS[@]}"; do
              if [ -f "$path/node" ] && [ -f "$path/npm" ]; then
                NODE_BIN="$path/node"
                NPM_BIN="$path/npm"
                export PATH="$path:$PATH"
                echo "Found Node.js at: $NODE_BIN"
                break
              fi
            done
          fi
          
          # Final fallback - try to find npm separately
          if [ -z "$NPM_BIN" ] || [ ! -f "$NPM_BIN" ]; then
            NPM_BIN=$(find /usr -name "npm" -type f 2>/dev/null | head -1)
            if [ -z "$NPM_BIN" ]; then
              NPM_BIN=$(find $HOME -name "npm" -type f 2>/dev/null | head -1)
            fi
            echo "Found npm at: $NPM_BIN"
          fi
          
          # Use system PATH as last resort
          if [ -z "$NODE_BIN" ]; then
            NODE_BIN=$(which node 2>/dev/null || echo "node")
            echo "Using system node: $NODE_BIN"
          fi
          
          if [ -z "$NPM_BIN" ]; then
            NPM_BIN=$(which npm 2>/dev/null || echo "npm")
            echo "Using system npm: $NPM_BIN"
          fi
        '

    - name: Start Fastify Backend
      run: |
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} '
          # Select target backend directory (supports repo path or app path)
          if [ -d "$HOME/freshshare1.3/fastify-backend" ]; then
            TARGET_DIR="$HOME/freshshare1.3/fastify-backend"
          elif [ -d "$HOME/repositories/FreshShare1.3/fastify-backend" ]; then
            TARGET_DIR="$HOME/repositories/FreshShare1.3/fastify-backend"
          else
            echo "ERROR: Could not find backend directory in ~/freshshare1.3/fastify-backend or ~/repositories/FreshShare1.3/fastify-backend"; exit 1
          fi
          echo "Using backend dir: $TARGET_DIR"
          cd "$TARGET_DIR"
          
          # Make startup script executable again (in case permissions were lost)
          chmod +x start-backend-prod.sh
          
          # Activate cPanel Node.js environment and detect node/npm
          echo "Activating cPanel Node.js environment..."
          if [ -f "$HOME/nodevenv/freshshare1.3/18/bin/activate" ]; then
            source "$HOME/nodevenv/freshshare1.3/18/bin/activate"
          else
            # Fallback: source the first available nodevenv activate script
            ACTIVATE_FILE=$(find "$HOME/nodevenv" -type f -name activate 2>/dev/null | head -1)
            if [ -n "$ACTIVATE_FILE" ]; then
              echo "Sourcing nodevenv: $ACTIVATE_FILE"
              source "$ACTIVATE_FILE"
            else
              # Last resort: add common paths
              for p in "/opt/cpanel/ea-nodejs18/bin" "/opt/cpanel/ea-nodejs20/bin"; do
                if [ -x "$p/node" ]; then export PATH="$p:$PATH"; fi
              done
            fi
          fi

          NODE_BIN=$(which node 2>/dev/null || true)
          NPM_BIN=$(which npm 2>/dev/null || true)
          echo "Detected NODE_BIN=$NODE_BIN"
          echo "Detected NPM_BIN=$NPM_BIN"
          # Print diagnostics
          echo "PATH=$PATH"
          if [ -n "$NODE_BIN" ]; then "$NODE_BIN" -v || true; fi
          if [ -n "$NPM_BIN" ]; then "$NPM_BIN" -v || true; fi
          if [ -z "$NODE_BIN" ] || [ -z "$NPM_BIN" ]; then
            echo "ERROR: node or npm not found in PATH after activation. Showing env for debugging:"
            env | grep -E "PATH|nodevenv" || true
            exit 1
          fi

          # Install required packages (omit --no-save for broad npm compatibility)
          echo "Installing Fastify dependencies with $NPM_BIN"
          "$NPM_BIN" install fastify pg dotenv || echo "WARNING: npm install returned non-zero; continuing"
          
          # Test database connection SEPARATELY before starting the server
          echo "Testing database connection (via temp JS file)..."
          cat > db-test.js << 'EOF'
          require('dotenv/config');
          const { Pool } = require('pg');
          const red = (u) => (u || '').replace(/:\/\/[^:]+:[^@]+@/, '://***:***@');
          const url = process.env.DATABASE_URL || 'postgres://localhost:5432/freshshare';
          const sslEnv = String(process.env.DATABASE_SSL || '').toLowerCase() === 'true';
          const requiresSSL = sslEnv || /sslmode=require|ssl=true|sslmode=no-verify|require/i.test(url);
          const poolConfig = { connectionString: url, ...(requiresSSL ? { ssl: { rejectUnauthorized: false } } : {}) };
          console.log('Testing connection to:', red(url), 'ssl:', requiresSSL);
          const pool = new Pool(poolConfig);
          pool.query('SELECT 1')
            .then(() => { console.log('✅ Database connection successful'); process.exit(0); })
            .catch((e) => { console.error('❌ Database connection failed:', e); process.exit(1); });
          EOF
          "$NODE_BIN" db-test.js || echo "WARNING: Database connection test failed, but continuing deployment"
          rm -f db-test.js
          
          # Stop any existing processes (ts-node/server.ts/pm2)
          echo "Stopping any existing Fastify processes (server.js/server.ts/ts-node/pm2)..."
          pkill -f "node.*server" || true
          pkill -f "ts-node" || true
          pkill -f "server.ts" || true
          pkill -f "/home/myfrovov/fastify-backend" || true
          if command -v pm2 >/dev/null 2>&1; then
            pm2 delete all || true
            pm2 kill || true
          fi
          
          # Start server with timeout protection to avoid hanging the GitHub Action
          echo "Starting Fastify backend with timeout protection..."
          if command -v timeout >/dev/null 2>&1; then
            timeout 20 ./start-backend-prod.sh || {
              echo "WARN: Server startup timed out after 20 seconds";
              echo "Starting in background without waiting for startup confirmation";
              nohup ./start-backend-prod.sh > fastify.log 2>&1 &
              echo "Process started with PID: $!"
            }
          else
            echo "timeout command not available; starting in background";
            nohup ./start-backend-prod.sh > fastify.log 2>&1 &
            echo "Process started with PID: $!"
          fi
          
          # Non-blocking check (GitHub Actions workflow will continue regardless)
          echo "Checking if status file was created..."
          if [ -f ".server_running" ]; then
            echo "✅ Fastify backend started successfully"
            cat .server_running
          else
            echo "⚠️ No status file yet, server may still be starting up"
            echo "Recent log entries:"
            tail -n 10 fastify.log || echo "No log file found"
          fi
          
          # Create a cron job to ensure the server stays running
          # Will check every 5 minutes and restart if needed
          CRON_JOB="*/5 * * * * cd $TARGET_DIR && ./start-backend-prod.sh >> cron.log 2>&1"
          (crontab -l 2>/dev/null | grep -v "fastify-backend && ./start-backend-prod.sh" || echo "") | { cat; echo "$CRON_JOB"; } | crontab -
          echo "✅ Added cron job to keep backend running"
        '

    - name: Start Express server
      run: |
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} myfrovov@${{ secrets.FTP_SERVER }} '
          # Select project root (Express)
          if [ -d "$HOME/freshshare1.3" ]; then
            PROJECT_ROOT="$HOME/freshshare1.3"
          elif [ -d "$HOME/repositories/FreshShare1.3" ]; then
            PROJECT_ROOT="$HOME/repositories/FreshShare1.3"
          else
            echo "ERROR: Could not find project root in ~/freshshare1.3 or ~/repositories/FreshShare1.3"; exit 1
          fi
          echo "Using project root: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"
          # Activate cPanel Node.js environment for Express as well
          echo "Activating cPanel Node.js environment (Express step)..."
          if [ -f "$HOME/nodevenv/freshshare1.3/18/bin/activate" ]; then
            source "$HOME/nodevenv/freshshare1.3/18/bin/activate"
          else
            ACTIVATE_FILE=$(find "$HOME/nodevenv" -type f -name activate 2>/dev/null | head -1)
            if [ -n "$ACTIVATE_FILE" ]; then
              echo "Sourcing nodevenv: $ACTIVATE_FILE"
              source "$ACTIVATE_FILE"
            else
              for p in "/opt/cpanel/ea-nodejs18/bin" "/opt/cpanel/ea-nodejs20/bin"; do
                if [ -x "$p/node" ]; then export PATH="$p:$PATH"; fi
              done
            fi
          fi

          NODE_BIN=$(which node 2>/dev/null || true)
          NPM_BIN=$(which npm 2>/dev/null || true)
          echo "Detected NODE_BIN=$NODE_BIN"
          echo "Detected NPM_BIN=$NPM_BIN"
          echo "PATH=$PATH"
          if [ -z "$NODE_BIN" ] || [ -z "$NPM_BIN" ]; then
            echo "ERROR: node/npm not found in Express step after activation"; exit 1
          fi

          # Install Express dependencies (no --production to avoid env-specific errors)
          echo "Installing Express dependencies with $NPM_BIN"
          "$NPM_BIN" install || echo "npm install failed for Express"
          
          # Make script executable
          chmod +x start-express.sh
          
          # Start Express server
          echo "Starting Express server in background..."
          nohup ./start-express.sh > express.log 2>&1 &
          EXPRESS_PID=$!
          echo "Express started with PID: $EXPRESS_PID"
          
          # Create a cron job to ensure Express stays running
          CRON_JOB="*/5 * * * * cd $HOME/freshshare1.3 && ./start-express.sh >> express_cron.log 2>&1"
          (crontab -l 2>/dev/null | grep -v "freshshare1.3/start-express.sh" || echo "") | { cat; echo "$CRON_JOB"; } | crontab -
          echo "✅ Added cron job to keep Express running"
          
          # Verify services are running
          echo "Currently running Node.js processes:"
          ps aux | grep node || echo "No node processes found"
        '
